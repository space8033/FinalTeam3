<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.finalteam3.exodia.note.dao.NoteDao">
	<insert id="insertNote" parameterType="Note">
		<selectKey keyProperty="note_no" resultType="int" order="BEFORE">
			select SEQ_NOTE.nextval from dual
		</selectKey>
		insert into NOTE(
        NOTE_NO, NOTE_TITLE, NOTE_CONTENT, NOTE_SENDER, NOTE_ISCANCELED, NOTE_CREATEDAT, NOTE_RESTIME
	    )
	    values(
	        #{note_no}, #{note_title}, #{note_content}, #{note_sender}, #{note_isCanceled}, to_char(sysdate,'yyyy.mm.dd hh24:mi:ss'), #{note_restime}
	    )
	</insert>
	
	<!-- 작성자: 김시온 -->
	<insert id="insertNoteRead" parameterType="NoteRead">
		<selectKey keyProperty="noteRead_no" resultType="int" order="BEFORE">
			select SEQ_NOTEREAD.nextval as noteRead_no from dual
		</selectKey>
		 insert into NOTEREAD(NOTEREAD_NO, NOTE_NO, EMP_NO_RECEIVER, NOTEREAD_TYPE)
  	     values(#{noteRead_no}, #{note_no}, #{emp_no_receiver}, #{noteRead_type})
	</insert> 
	
	<!-- 수신 쪽지 목록  -->
	<select id="selectNoteByEmpNo" resultType="NoteAll" parameterType="Map">
		<![CDATA[
	       select rnum, note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, noteRead_no, emp_no_receiver, noteRead_read, noteRead_type, noteRead_starred
			 from (
			    select rownum as rnum, note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, noteRead_no, emp_no_receiver, noteRead_read, noteRead_type, noteRead_starred
			    from(
			        select n.note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, noteRead_no, emp_no_receiver, noteRead_read, noteRead_type, noteRead_starred
			        from note n, noteRead nr
			        where emp_no_receiver = #{empNo} and n.note_no = nr.note_no
			        order by note_createdAt desc
			    )
			    where rownum <= #{endRowNo}
			 )
			 where rnum >= #{startRowNo}
		]]>
	</select>
	
	<!-- 발신 쪽지 목록 -->
	<select id="selectSentNoteByEmpNo" resultType="NoteAll" parameterType="Map">
		<![CDATA[
	       select rnum, note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, noteRead_no, emp_no_receiver, noteRead_read, noteRead_type, noteRead_starred
			 from (
			    select rownum as rnum, note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, noteRead_no, emp_no_receiver, noteRead_read, noteRead_type, noteRead_starred
			    from(
			        select n.note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, noteRead_no, emp_no_receiver, noteRead_read, noteRead_type, noteRead_starred
			        from note n, noteRead nr
			        where note_sender = #{empNo} and n.note_no = nr.note_no
			        order by note_createdAt desc
			    )
			    where rownum <= #{endRowNo}
			 )
			 where rnum >= #{startRowNo}
		]]>
	</select>
	
	<!-- 수신 쪽지 갯수 가져오기 -->
	<select id="countByEmpno" parameterType="int" resultType="int">
		select count(*)
  		from noteRead
  		where emp_no_receiver = #{emp_no_receiver}
	</select>
	
	<!-- 발신 쪽지 갯수 가져오기 -->
	<select id="countBySentEmpno" parameterType="int" resultType="int">
		select count(*)
  		from note
  		where note_sender = #{note_sender}
	</select>
	
	<!-- 쪽지 번호로 noteRead 얻어오기 작성자: 김시온 -->
	<select id="selectNoteRead" parameterType="int" resultType="noteRead">
		select noteRead_read, note_no
  		from noteRead
  		where noteRead_no = #{noteRead_no}
	</select>
	
	<!-- 쪽지 번호로 noteRead 얻어오기 작성자: 김시온 -->
	<select id="selectNoteByNoteNo" parameterType="int" resultType="note">
		select note_no, note_title, note_content, note_sender, note_isCanceled, note_createdAt, note_deletedAt, note_restime
  		from note
  		where note_no = #{note_no}
	</select>
	
	<!-- 쪽지 번호로 noteRead 읽음 업데이트 작성자: 김시온 -->
	<insert id="updateNoteRead" parameterType="int">
		update noteRead set noteRead_read=to_char(sysdate,'yyyy.mm.dd hh24:mi:ss')
  		where noteRead_no = #{noteRead_no}
	</insert>


	
</mapper>